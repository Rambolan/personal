<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>简单登录测试</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 50px; }
        .log { border: 1px solid #ddd; padding: 10px; max-height: 300px; overflow-y: auto; font-family: monospace; }
        .error { color: red; }
        .success { color: green; }
    </style>
</head>
<body>
    <h2>简单登录测试</h2>
    <button onclick="testLogin()">测试登录请求</button>
    <div id="result">点击按钮开始测试...</div>
    <div id="log" class="log"></div>

    <script>
        // 日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = type;
            entry.textContent = new Date().toLocaleTimeString() + ': ' + message;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console[type === 'error' ? 'error' : 'log'](message);
        }

        // 更新结果
        function updateResult(message, type = 'error') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = type;
            resultDiv.textContent = message;
        }

        // 测试登录请求
        function testLogin() {
            updateResult('开始测试登录请求...');
            log('开始测试登录流程');

            // 清除之前的日志
            document.getElementById('log').innerHTML = '';
            
            // 准备请求数据
            const username = 'admin';
            const password = 'admin123';
            const data = JSON.stringify({ username, password });
            
            log(`准备发送登录请求，数据: ${data}`);
            
            try {
                // 创建XMLHttpRequest对象
                const xhr = new XMLHttpRequest();
                
                // 设置各种事件监听器
                xhr.onreadystatechange = function() {
                    log(`状态变化: readyState=${xhr.readyState}, status=${xhr.status}`);
                    
                    if (xhr.readyState === 1) {
                        log('请求已打开');
                    } else if (xhr.readyState === 2) {
                        log('收到响应头');
                        log('响应头: ' + xhr.getAllResponseHeaders());
                    } else if (xhr.readyState === 3) {
                        log('正在接收响应体');
                    } else if (xhr.readyState === 4) {
                        log(`请求完成，最终状态: ${xhr.status}`);
                        log(`响应内容: ${xhr.responseText}`);
                        
                        try {
                            // 尝试解析响应
                            if (xhr.status === 200) {
                                try {
                                    const response = JSON.parse(xhr.responseText);
                                    log('解析成功: ' + JSON.stringify(response), 'success');
                                    updateResult('登录成功! 响应: ' + JSON.stringify(response), 'success');
                                } catch (e) {
                                    log('解析JSON失败: ' + e.message, 'error');
                                    updateResult('响应不是有效JSON: ' + xhr.responseText);
                                }
                            } else {
                                log(`HTTP错误: ${xhr.status}`, 'error');
                                updateResult(`HTTP错误: ${xhr.status} - ${xhr.statusText}`);
                            }
                        } catch (e) {
                            log('处理响应时出错: ' + e.message, 'error');
                            updateResult('处理响应时出错: ' + e.message);
                        }
                    }
                };
                
                // 网络错误
                xhr.onerror = function(e) {
                    log('网络错误: ' + e.type, 'error');
                    updateResult('网络错误，请检查CORS设置或网络连接');
                    
                    // 检查是否是CORS问题
                    log('可能的CORS问题，请检查后端是否正确配置了CORS', 'error');
                };
                
                // 请求超时
                xhr.ontimeout = function() {
                    log('请求超时', 'error');
                    updateResult('请求超时');
                };
                
                // 加载开始
                xhr.onloadstart = function() {
                    log('请求开始发送');
                };
                
                // 加载完成
                xhr.onload = function() {
                    log('请求加载完成，状态: ' + xhr.status);
                };
                
                // 配置请求
                xhr.open('POST', 'http://8.136.34.190:3000/api/users/login', true);
                xhr.timeout = 10000; // 10秒超时
                
                // 设置请求头
                xhr.setRequestHeader('Content-Type', 'application/json');
                xhr.setRequestHeader('Accept', '*/*');
                xhr.setRequestHeader('Origin', 'http://localhost:8080');
                
                // 启用凭证
                xhr.withCredentials = true;
                
                log('请求已配置，准备发送');
                
                // 发送请求
                try {
                    xhr.send(data);
                    log('请求已发送');
                    updateResult('请求已发送，等待响应...');
                } catch (sendError) {
                    log('发送请求时出错: ' + sendError.message, 'error');
                    updateResult('发送请求失败: ' + sendError.message);
                }
            } catch (error) {
                log('初始化请求时出错: ' + error.message, 'error');
                updateResult('初始化请求失败: ' + error.message);
            }
        }
    </script>
</body>
</html>