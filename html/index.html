<!DOCTYPE html>
<html lang="en" ">
<head>
    <meta charset="UTF-8">
    <title>个人网站</title>
    <link type="text/css" rel="stylesheet" href="../css/index.css"/>
    <link type="text/css" rel="stylesheet" href="../css/common.css"/>
    <!-- 引入图标样式文件 -->
    <link type="text/css" rel="stylesheet" href="../iconfont/iconfont.css">
    <script type="text/javascript" src="../script.js"></script>
<script type="text/javascript">
function saveProduct() {
  const id = document.getElementById('product-id').value;
  const title = document.getElementById('product-title').value;
  const description = document.getElementById('product-description').value;
  const stars = document.getElementById('product-stars').value;
  const tagsInput = document.getElementById('product-tags').value;
  const imageFiles = document.getElementById('product-images').files;
  
  console.log('开始保存作品，ID:', id);
  console.log('表单数据 - 标题:', title);
  console.log('表单数据 - 图片数量:', imageFiles ? imageFiles.length : 0);
  
  // 验证必填字段
  if (!title) {
    alert('请输入作品标题');
    return;
  }
  
  if (!imageFiles || imageFiles.length === 0) {
    alert('请至少上传一张作品图片');
    return;
  }
  
  // 处理标签
  let tags = [];
  if (tagsInput) {
    tags = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag);
  }
  
  const formData = new FormData();
  formData.append('title', title);
  formData.append('description', description || '');
  formData.append('stars', stars || 0);
  formData.append('tags', JSON.stringify(tags));
  
  // 添加图片文件
  console.log('准备添加图片文件:');
  for (let i = 0; i < imageFiles.length; i++) {
    console.log(`- 文件 ${i+1}: ${imageFiles[i].name}, 大小: ${imageFiles[i].size} bytes, 类型: ${imageFiles[i].type}`);
    formData.append('images', imageFiles[i]);
  }
  
  // 检查FormData内容
  console.log('FormData字段列表:', [...formData.keys()]);
  console.log('发送请求前的最终检查:');
  console.log('- 标题存在:', !!formData.get('title'));
  console.log('- 至少有一个图片:', imageFiles.length > 0);
  
  const url = id ? `http://8.136.34.190:3000/api/products/${id}` : 'http://8.136.34.190:3000/api/products';
  const method = id ? 'PUT' : 'POST';
  
  console.log(`准备发送${method}请求到: ${url}`);
  
  fetch(url, {
    method: method,
    headers: {
      'Authorization': `Bearer ${localStorage.getItem('token')}`,
      // 注意：不要手动设置Content-Type，浏览器会自动设置multipart/form-data边界
    },
    body: formData,
    credentials: 'include' // 确保包含凭证信息
  })
  .then(response => {
    console.log('收到响应，状态码:', response.status);
    console.log('响应头部 - Content-Type:', response.headers.get('content-type'));
    
    // 读取响应文本，而不是直接解析JSON
    return response.text().then(text => {
      console.log('响应原始内容:', text);
      
      try {
        const data = JSON.parse(text);
        if (!response.ok) {
          throw new Error(JSON.stringify(data));
        }
        return data;
      } catch (e) {
        // 如果响应不是有效的JSON
        if (!response.ok) {
          throw new Error(`HTTP错误! 状态: ${response.status}, 响应: ${text}`);
        }
        throw new Error(`无效的JSON响应: ${text}`);
      }
    });
  })
  .then(data => {
    console.log('请求成功:', data);
    alert('保存成功');
    location.reload(); // 刷新页面
  })
  .catch(error => {
    console.error('保存失败 - 详细错误:', error);
    console.error('错误类型:', typeof error);
    console.error('错误栈:', error.stack);
    alert('保存失败: ' + error.message);
  });
}
</script>
</head>
<body class="background">
        <!-- 导航菜单区域 -->  
        <div data-include="partials/header.html"></div>
        <!-- 轮播图区域 --> 
        <div class="nav">
            <div class="nav-left">
                <p class="biaoti" >你好！我是兰博</p>
                <p class="jianshu" >资深用户体验设计师 & 前端开发工程师</p>
                <div style="display: flex;">
                    <h1>UI/UX 设计</h1>
                    <h2>前端开发</h2>
                    <h3>产品设计</h3>
                </div>
                <div class="tool-container" >
                   <span class="iconfont icon-AdobePs"></span>
                   <span class="iconfont icon-Figma"></span>
                   <span class="iconfont icon-sketch"></span>
                   <span class="iconfont icon-logo-mastergo"></span>
                   <span class="iconfont icon-modao"></span>
                   <span class="iconfont icon-AxureRP"></span>
                   <span class="iconfont icon-ai"></span>
                </div>
            </div>
            <div class="nav-right" >
                <img src="../img/katong.png" alt="卡通人物">
            </div>       
        </div>
        <!-- 精选作品 -->
        <div class="container">
            <div class="product-container"><!-- 精选作品容器 -->
                <div class="product-top">
                    <p class="title">精选作品</p>
                    <p class="description">展示我在设计和开发领域的精选作品</p>
                </div>
                <div id="featured-products-list" class="product-list"><!-- 作品列表容器 -->
                    <!-- 动态加载的精选作品将显示在这里 -->
                    <div class="loading">加载中...</div>
                </div>       
                <!-- 查看更多入口 -->
                <div class="view-more-wrapper">
                    <a class="view-more-link" href="product.html">查看更多作品</a>
                </div>
            </div>  
        </div>
        
        <script>
        // 页面加载完成后获取精选作品
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 调用API获取精选作品，设置featured=true只获取精选作品
                const response = await fetch('http://8.136.34.190:3000/api/products?featured=true&limit=6&sort=date&order=DESC');
                
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                
                const data = await response.json();
                
                // 获取作品列表容器
                const productListContainer = document.getElementById('featured-products-list');
                
                // 清空加载状态
                productListContainer.innerHTML = '';
                
                if (data.success && data.data && data.data.length > 0) {
                    // 将作品分为两行，每行最多3个
                    const products = data.data;
                    const rows = Math.ceil(products.length / 3);
                    
                    for (let r = 0; r < rows; r++) {
                        const rowDiv = document.createElement('div');
                        rowDiv.className = 'rows';
                        
                        // 获取当前行的作品
                        const startIdx = r * 3;
                        const endIdx = Math.min(startIdx + 3, products.length);
                        const rowProducts = products.slice(startIdx, endIdx);
                        
                        // 为每个作品创建HTML
                        rowProducts.forEach(product => {
                            const productDiv = document.createElement('div');
                            productDiv.className = 'product';
                            
                            // 构建作品标签
                            const tagsHtml = product.tags && product.tags.length > 0 
                                ? product.tags.slice(0, 2).map((tag, idx) => 
                                    `<h${idx + 1} class="tag">${tag}</h${idx + 1}>`
                                  ).join('')
                                : '';
                            
                            productDiv.innerHTML = `
                                <img src="${product.cover}" alt="${product.title}">
                                <div class="bottom">
                                    <p class="product-title">${product.title}</p>
                                    <p class="product-description">${product.description || '暂无描述'}</p>
                                    <div class="product-tag">
                                        ${tagsHtml}
                                    </div>
                                </div>
                            `;
                            
                            // 添加点击事件，跳转到作品详情页
                            productDiv.addEventListener('click', () => {
                                window.location.href = `product-detial.html?id=${product.id}`;
                            });
                            
                            rowDiv.appendChild(productDiv);
                        });
                        
                        productListContainer.appendChild(rowDiv);
                    }
                } else {
                    // 如果没有精选作品，显示提示信息
                    productListContainer.innerHTML = `
                        <div class="no-products">
                            <p>暂无精选作品</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('获取精选作品失败:', error);
                const productListContainer = document.getElementById('featured-products-list');
                productListContainer.innerHTML = `
                    <div class="no-products">
                        <p>加载失败，请稍后重试</p>
                    </div>
                `;
            }
        });
        </script>
        <!--最新文章-->        <div class="article-container"><!-- 最新文章容器 -->            <div class="article"><!-- 最新文章背景 -->                <div class="article-top">                    <p class="title">最新文章</p>                    <p class="description">展示我的工作及设计经验</p>                </div>                <!-- 文章列表 -->                <div class="article-list" id="featured-articles-list">                    <!-- 动态加载的精选文章将显示在这里 -->                    <div class="loading">加载中...</div>                </div>                 <!-- 查看更多文章入口 -->                <div class="view-more-articles-wrapper">                    <a class="view-more-articles-link" href="artical.html">查看更多文章</a>                </div>            </div>  
        </div>
        <script>
        // 页面加载完成后获取精选文章
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                // 调用API获取精选文章，设置featured=true只获取精选文章，不设置limit参数以获取所有精选文章
                const response = await fetch('http://8.136.34.190:3000/api/articles?featured=true');
                
                if (!response.ok) {
                    throw new Error('网络请求失败');
                }
                
                const data = await response.json();
                
                // 获取文章列表容器
                const articleListContainer = document.getElementById('featured-articles-list');
                
                // 清空加载状态
                articleListContainer.innerHTML = '';
                
                if (data.success && data.data && data.data.articles && data.data.articles.length > 0) {
                    const articles = data.data.articles;
                    
                    // 为每篇文章创建HTML
                    articles.forEach(article => {
                        // 格式化日期
                        const date = new Date(article.createdAt || article.publishDate);
                        const formattedDate = `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
                        
                        // 创建文章项
                        const articleDiv = document.createElement('div');
                        articleDiv.className = 'article-item';
                        articleDiv.setAttribute('data-id', article.id); // 设置文章ID属性
                        
                        // 添加鼠标悬停样式提示
                        articleDiv.style.cursor = 'pointer';
                          
                        // 提取文章内容的前100个字符作为描述
                        let description = '';
                        if (article.content) {
                            // 移除HTML标签
                            description = article.content.replace(/<[^>]*>/g, '');
                            // 截取前100个字符
                            if (description.length > 100) {
                                description = description.substring(0, 100) + '...';
                            }
                        }
                        
                        // 标签处理（暂时使用默认标签，实际项目中可以从文章数据中获取）
                        const tags = ['设计', '前端'];
                        const tagsHtml = tags.slice(0, 2).map((tag, idx) => 
                            `<h${idx + 1} class="tag">${tag}</h${idx + 1}>`
                        ).join('');
                        
                        articleDiv.innerHTML = `
                            <div class="article-info">
                                <p>${formattedDate}</p>
                                <p>阅读时间:${Math.ceil((article.content || '').length / 1000)}分钟</p>
                             </div>
                            <p class="article-title">${article.title}</p>
                            <p class="article-description">${description || '暂无描述'}</p>
                            <div class="tag-more">
                                <div class="article-tag">
                                    ${tagsHtml}
                                </div>
                                <div class="more">
                                    阅读更多
                                </div>
                             </div>
                        `;
                        
                        // 为整个文章项添加点击事件，跳转到文章详情页
                        articleDiv.addEventListener('click', () => {
                            window.location.href = `artical-detial.html?id=${article.id}`;
                        });
                        
                        articleListContainer.appendChild(articleDiv);
                    });
                } else {
                    // 如果没有精选文章，显示提示信息
                    articleListContainer.innerHTML = `
                        <div class="no-articles">
                            <p>暂无精选文章</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('获取精选文章失败:', error);
                const articleListContainer = document.getElementById('featured-articles-list');
                articleListContainer.innerHTML = `
                    <div class="no-articles">
                        <p>加载失败，请稍后重试</p>
                    </div>
                `;
            }
        });
        </script>
        <!--底部-->
        <div data-include="partials/footer.html"></div>
</body>
</html>
