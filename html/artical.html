<!DOCTYPE html>
<html lang="en" ">
<head>
    <meta charset="UTF-8">
    <title>个人网站</title>
    <link type="text/css" rel="stylesheet" href="../css/common.css"/>
    <link type="text/css" rel="stylesheet" href="../css/artical.css"/>
    <script type="text/javascript" src="../script.js"></script>
    <!-- 引入图标样式文件 -->
    <link type="text/css" rel="stylesheet" href="../iconfont/iconfont.css">
    <style>
        /* 分页器样式 */
        .page-container {
            display: flex;
            list-style: none;
            padding: 0;
            margin: 30px 0 0 0;
            gap: 10px;
        }
        
        .page-container li {
            padding: 8px 16px;
            background-color: #ffffff;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .page-container li:hover {
            background-color: #f0f0f0;
        }
        
        .page-container li.active {
            background-color: #3B82F6;
            color: white;
        }
        
        .page-container li.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .page-container li.ellipsis {
            cursor: default;
            background-color: transparent;
            padding: 8px 4px;
        }
        
        .page-container li.ellipsis:hover {
            background-color: transparent;
        }
        
        /* 排序图标样式 */
        .sort-icon {
            transition: transform 0.3s ease;
        }
        
        .sort-icon.asc {
            transform: rotate(180deg);
        }
        
        /* 视图切换按钮样式 */
        .Adjust-the-layout {
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .Adjust-the-layout.active {
            background-color: #EFF6FF;
        }
        
        .Adjust-the-layout.active span {
            color: #3B82F6;
        }
        
        /* 宫格视图样式 */
        .article-rows {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .article-grid-item {
            flex: 1;
            min-width: calc(50% - 10px);
            background: white;
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .article-grid-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }
        
        
        .article-grid-info {
            display: flex;
            flex-direction: column;
            padding: 24px;
        }
    </style>
</head>
<body class="background">    
        <div data-include="partials/header.html"></div>
        <div class="container"><!-- 中间容器 --> 
            <div class="title">文章</div>
            <div class="Filter-Bar"><!-- 筛选栏 -->
                <div class="left">
                    <div class="time" style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <span class="iconfont icon-a-paixu-zhengpaixu1x sort-icon" id="sortIcon" style="font-size: 16px; color: #3B82F6;"></span>
                            <p>按时间排序</p>
                        </div>
                    
                </div>
                <div class="right">
                    <div class="Adjust-the-layout grid-view-btn active">
                        <span class="iconfont icon-dasuolvetuliebiao"></span>
                    </div>
                    <div class="Adjust-the-layout list-view-btn">
                        <span class="iconfont icon-liebiao"></span>
                    </div>
                </div>
                
                <style>
                    /* 视图切换按钮样式 */
                    .Adjust-the-layout {
                        display: flex;
                        gap: 8px;
                        margin: 0;
                        padding: 14px;
                        list-style: none;
                    }
                    .Adjust-the-layout li {
                        width: 32px;
                        height: 32px;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                        background-color: #f5f5f5;
                        border-radius: 4px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                    }
                    .Adjust-the-layout li:hover {
                        background-color: #e5e5e5;
                    }
                    .Adjust-the-layout li.active {
                        background-color: #3B82F6;
                    }
                    .Adjust-the-layout li.active span {
                        color: white;
                    }
                    .Adjust-the-layout span {
                        font-size: 16px;
                        color: #666;
                    }
                    
                    /* 宫格视图样式 */
                    .article-rows {
                        display: grid;
                        grid-template-columns: repeat(3, 1fr);
                        gap: 20px;
                    }
                    .article-grid-item {
                        border: 1px solid #e5e7eb;
                        border-radius: 12px;
                        overflow: hidden;
                        transition: all 0.3s ease;
                        cursor: pointer;
                    }
                    .article-grid-item:hover {
                        box-shadow: 
                        0 2px 4px rgba(0, 0, 0, 0.05),
                        0 8px 16px rgba(0, 0, 0, 0.08),
                        0 16px 32px rgba(0, 0, 0, 0.06);
                        transform: translateY(-4px) translateZ(0);
                    }

                    /* 文章标题单行显示 */
                    .article-grid-item h3,
                    .article-item h3 {
                        white-space: nowrap;
                        overflow: hidden;
                        text-overflow: ellipsis;
                        margin: 0 0 8px 0;
                        font-size: 16px;
                        font-weight: 600;
                    }
                </style>
            </div>
            <div class="article-container" id="articleContainer"></div>
            <ul class="page-container" id="pagination"></ul>   
        </div>   
        <div data-include="partials/footer.html"></div>         
        <script>
            // 全局变量
            let currentPage = 1;
            const pageSize = 5;
            let sortOrder = 'desc'; // 默认降序（最新的在前）
            let articlesData = []; // 将从API获取
            let sortedArticles = [];
            let currentView = 'grid'; // 默认宫格视图
            
            // 从API获取文章数据
            async function fetchArticles() {
                try {
                    const response = await fetch('http://8.136.34.190:3000/api/articles');
                    
                    if (!response.ok) {
                        throw new Error('Failed to fetch articles: ' + response.statusText);
                    }
                    
                    const apiResponse = await response.json();
                    
                    // 正确提取API响应中的文章数据
                    // API返回格式: {"success":true,"data":{"articles":[...],"total":3}}
                    let articlesArray = [];
                    
                    // 主要处理API返回的标准格式
                    if (apiResponse.data && Array.isArray(apiResponse.data.articles)) {
                        articlesArray = apiResponse.data.articles;
                    }
                    // 兼容其他可能的格式
                    else if (apiResponse.data && Array.isArray(apiResponse.data)) {
                        articlesArray = apiResponse.data;
                    }
                    else if (Array.isArray(apiResponse.articles)) {
                        articlesArray = apiResponse.articles;
                    }
                    else if (Array.isArray(apiResponse)) {
                        articlesArray = apiResponse;
                    }
                    
                    // 过滤只显示已发布的文章（status为true）
                    articlesData = articlesArray.filter(article => {
                        // 数据库中status存储的是布尔值，true表示已发布
                        return article.status === true || article.status === 'published';
                    });
                    
                    return articlesData;
                } catch (error) {
                    console.error('Error fetching articles:', error);
                    throw error; // 重新抛出错误，让调用者处理
                }
            }
            
            // 使用备用数据（当API不可用时）
            function useFallbackData() {
                articlesData = [
                    {
                        id: 1,
                        title: "巨湾科技荣获中国测绘学会'2023年测绘科学技术奖'一等奖、二等奖",
                        description: "近日，中国测绘学会'2023年测绘科学技术奖'评选结果公布。深圳巨湾科技有限公司凭借'自然资源资产全价值评估核算关键技术及应用'项目、'空天地一体化时空数据智能处理技术及其测绘国际应用'项目分别荣获2023年测绘科学技术奖一等奖、二等奖。",
                        publishDate: "2023-12-20T00:00:00.000Z",
                        cover: "../img/article-img.png"
                    },
                    {
                        id: 2,
                        title: "人工智能在城市规划中的创新应用与实践",
                        description: "本文探讨了人工智能技术如何在现代城市规划中发挥关键作用，通过数据分析和机器学习算法优化城市布局、交通系统和公共服务，实现智慧城市的可持续发展。",
                        publishDate: "2023-11-15T00:00:00.000Z",
                        cover: "../img/ai.png"
                    },
                    {
                        id: 3,
                        title: "数字孪生技术在工业制造中的实施案例研究",
                        description: "数字孪生技术作为工业4.0的核心组成部分，正在改变传统制造业的生产模式。本文通过多个行业领先企业的实际案例，深入分析了数字孪生技术的实施路径和价值创造。",
                        publishDate: "2023-10-08T00:00:00.000Z",
                        cover: "../img/work_img.png"
                    }
                ];
                return articlesData;
            }
            
            // DOM元素
            const articleContainer = document.getElementById('articleContainer');
            const pagination = document.getElementById('pagination');
            const sortIcon = document.getElementById('sortIcon');
            const timeSortButton = document.querySelector('.time');
            const gridViewBtn = document.querySelector('.grid-view-btn');
            const listViewBtn = document.querySelector('.list-view-btn');
            
            // 初始化
            async function init() {
                // 显示加载状态
                if (articleContainer) {
                    articleContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;">正在加载文章...</div>';
                }
                
                try {
                    // 从API获取文章数据
                    await fetchArticles();
                } catch (error) {
                    console.error('加载文章失败:', error);
                    // 使用备用数据
                    useFallbackData();
                } finally {
                    // 无论成功失败，都执行以下操作
                    // 设置排序顺序（默认降序）
                    sortOrder = 'desc';
                    
                    // 排序文章
                    sortArticles();
                    
                    // 渲染文章列表
                    renderArticles(currentPage);
                    
                    // 渲染分页器
                    renderPagination();
                }
                
                // 添加事件监听器
                timeSortButton.addEventListener('click', toggleSortOrder);
                gridViewBtn.addEventListener('click', function() {
                    currentView = 'grid';
                    updateViewIcons();
                    renderArticles(currentPage);
                });
                listViewBtn.addEventListener('click', function() {
                    currentView = 'list';
                    updateViewIcons();
                    renderArticles(currentPage);
                });
            }
            
            // 更新视图图标状态
            function updateViewIcons() {
                // 移除所有视图按钮的激活状态
                gridViewBtn.classList.remove('active');
                listViewBtn.classList.remove('active');
                
                // 根据当前视图激活对应的按钮
                if (currentView === 'grid') {
                    gridViewBtn.classList.add('active');
                } else {
                    listViewBtn.classList.add('active');
                }
            }

            
            // 切换排序顺序
            function toggleSortOrder() {
                sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
                applyTimeSort();
                renderArticles(1); // 重新从第一页开始显示
                renderPagination();
            }
            
            // 应用时间排序
            function applyTimeSort() {
                // 更新图标状态
                sortIcon.classList.toggle('asc', sortOrder === 'asc');
                
                // 排序文章
                sortedArticles.sort((a, b) => {
                    const dateA = new Date(a.date.replace(/年|月/g, '-').replace('日', ''));
                    const dateB = new Date(b.date.replace(/年|月/g, '-').replace('日', ''));
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });
            }
            
            // 文章排序函数
            function sortArticles() {
                sortedArticles = [...articlesData].sort((a, b) => {
                    const dateA = new Date(a.createdAt).getTime();
                    const dateB = new Date(b.createdAt).getTime();
                    return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
                });
            }
            
            // 从HTML内容中提取纯文本的函数
            function extractTextFromHtml(html) {
                if (!html) return '';
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = html;
                return tempDiv.textContent || tempDiv.innerText || '';
            }
            
            // 处理图片URL，确保正确指向后端服务器
            function processImageUrl(url) {
                if (!url) return '';
                
                // 已经是完整URL的不处理
                if (url.startsWith('http://') || url.startsWith('https://')) {
                    return url;
                }
                
                // 将/uploads/开头的相对路径转换为后端服务器的绝对路径
                if (url.startsWith('/uploads/')) {
                    return `http://8.136.34.190:3000${url}`;
                }
                
                // 其他情况保持不变
                return url;
            }
            
            // 渲染文章列表
            function renderArticles(page) {
                articleContainer.innerHTML = '';
                
                // 根据当前视图模式设置每页显示数量
                const currentPageSize = currentView === 'grid' ? 6 : pageSize;
                
                // 计算当前页的文章数据
                const startIndex = (page - 1) * currentPageSize;
                const endIndex = startIndex + currentPageSize;
                const currentArticles = sortedArticles.slice(startIndex, endIndex);
                
                if (currentView === 'grid') {
                    // 宫格视图
                    const row = document.createElement('div');
                    row.className = 'article-rows';
                    
                    currentArticles.forEach(article => {
                        const articleEl = document.createElement('div');
                        articleEl.className = 'article-grid-item';
                        
                        // 格式化日期显示
                        const formattedDate = new Date(article.createdAt).toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        // 生成摘要（如果没有description字段，从content中提取纯文本）
                        const description = article.description || (article.content ? extractTextFromHtml(article.content).substring(0, 100) + '...' : '');
                        
                        articleEl.innerHTML = `
                            <div class="article-grid-content">
                                <img src="${processImageUrl(article.cover)}" alt="${article.title}" style="width: 100%; height: auto; object-fit: cover; border-radius: 12px 12px 0px 0px; ">
                                <div class="article-grid-info">
                                    <p class="article-title">${article.title}</p>
                                    <p class="article-description">${description}</p>
                                    <div class="left-bottom-container" style="display: flex; align-items: center;">
                                        <span class="iconfont icon-shijian"></span>
                                        <p style="font-size: 14px; color: #808a99;">${formattedDate}</p>
                                    </div>
                                </div>
                            </div>
                        `;
                        
                        articleEl.addEventListener('click', () => {
                            window.location.href = `artical-detial.html?id=${article.id}`;
                        });
                        
                        row.appendChild(articleEl);
                    });
                    
                    articleContainer.appendChild(row);
                } else {
                    // 列表视图
                    currentArticles.forEach(article => {
                        const articleEl = document.createElement('div');
                        articleEl.className = 'article-list-container';
                        
                        // 格式化日期显示
                        const formattedDate = new Date(article.createdAt).toLocaleDateString('zh-CN', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric'
                        });
                        
                        // 生成摘要
                        const description = article.description || (article.content ? extractTextFromHtml(article.content).substring(0, 100) + '...' : '');
                        
                        articleEl.innerHTML = `
                            <div class="left-container">
                                <div class="left-top-container">
                                    <p class="article-title">${article.title}</p>
                                    <p class="article-description" style="display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis;">${description}</p>
                                </div>
                                <div class="left-bottom-container">
                                    <span class="iconfont icon-shijian" style="font-size: 16px; color: #808a99;"></span>
                                    <p>${formattedDate}</p>
                                </div>
                            </div>
                            <div class="right-container">
                                    <img src="${processImageUrl(article.cover)}" alt="${article.title}" style="width: 356px; height: 200px; object-fit: cover; border-radius: 6px;border: 1px solid #e5e7eb;">
                                </div>
                        `;
                        
                        articleEl.addEventListener('click', () => {
                            window.location.href = `artical-detial.html?id=${article.id}`;
                        });
                        
                        articleContainer.appendChild(articleEl);
                    });
                }
            }
            
            // 渲染分页器
            function renderPagination() {
                pagination.innerHTML = '';
                
                // 根据当前视图模式重新计算总页数
                const currentPageSize = currentView === 'grid' ? 6 : pageSize;
                const currentTotalPages = Math.ceil(sortedArticles.length / currentPageSize);
                
                // 确保当前页码有效
                if (currentPage > currentTotalPages && currentTotalPages > 0) {
                    currentPage = currentTotalPages;
                }
                
                // 上一页按钮
                const prevButton = document.createElement('li');
                prevButton.textContent = '上一页';
                prevButton.disabled = currentPage === 1;
                prevButton.classList.toggle('disabled', currentPage === 1);
                prevButton.addEventListener('click', () => {
                    if (currentPage > 1) {
                        currentPage--;
                        renderArticles(currentPage);
                        renderPagination();
                    }
                });
                pagination.appendChild(prevButton);
                
                // 页码按钮
                // 简化版分页，只显示当前页附近的页码
                const showRange = 2; // 当前页前后显示的页码数量
                let startPage = Math.max(1, currentPage - showRange);
                let endPage = Math.min(currentTotalPages, currentPage + showRange);
                
                // 如果前面有页码，添加省略号
                if (startPage > 1) {
                    const firstPage = document.createElement('li');
                    firstPage.textContent = '1';
                    firstPage.classList.toggle('active', 1 === currentPage);
                    firstPage.addEventListener('click', () => {
                        currentPage = 1;
                        renderArticles(currentPage);
                        renderPagination();
                    });
                    pagination.appendChild(firstPage);
                    
                    if (startPage > 2) {
                        const ellipsis1 = document.createElement('li');
                        ellipsis1.textContent = '...';
                        ellipsis1.className = 'ellipsis';
                        pagination.appendChild(ellipsis1);
                    }
                }
                
                // 生成中间的页码
                for (let i = startPage; i <= endPage; i++) {
                    const pageButton = document.createElement('li');
                    pageButton.textContent = i;
                    pageButton.classList.toggle('active', i === currentPage);
                    pageButton.addEventListener('click', () => {
                        currentPage = i;
                        renderArticles(currentPage);
                        renderPagination();
                    });
                    pagination.appendChild(pageButton);
                }
                
                // 如果后面有页码，添加省略号
                if (endPage < currentTotalPages) {
                    if (endPage < currentTotalPages - 1) {
                        const ellipsis2 = document.createElement('li');
                        ellipsis2.textContent = '...';
                        ellipsis2.className = 'ellipsis';
                        pagination.appendChild(ellipsis2);
                    }
                    
                    const lastPage = document.createElement('li');
                    lastPage.textContent = currentTotalPages;
                    lastPage.classList.toggle('active', currentTotalPages === currentPage);
                    lastPage.addEventListener('click', () => {
                        currentPage = currentTotalPages;
                        renderArticles(currentPage);
                        renderPagination();
                    });
                    pagination.appendChild(lastPage);
                }
                
                // 下一页按钮
                const nextButton = document.createElement('li');
                nextButton.textContent = '下一页';
                nextButton.disabled = currentPage === currentTotalPages;
                nextButton.classList.toggle('disabled', currentPage === currentTotalPages);
                nextButton.addEventListener('click', () => {
                    if (currentPage < currentTotalPages) {
                        currentPage++;
                        renderArticles(currentPage);
                        renderPagination();
                    }
                });
                pagination.appendChild(nextButton);
            }
            
            // 页面加载完成后初始化
            document.addEventListener('DOMContentLoaded', init);
        </script>
</body>
</html>